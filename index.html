<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Department Budget Allocation</title>
  <style>
    :root {
      --primary-color: #3f51b5;
      --secondary-color: #f5f5f5;
      --accent-color: #ff4081;
      --text-color: #333;
      --light-gray: #e0e0e0;
      --danger-color: #f44336;
      --danger-bg: #ffebee;
      --success-color: #4caf50;
    }

    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      margin: 0;
      padding: 20px;
      background-color: #f9f9f9;
      color: var(--text-color);
      min-width: 1400px;
      /* Prevent wrapping on small screens */
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
      /* Allow horizontal scrolling */
    }

    h1 {
      color: var(--primary-color);
      margin-top: 0;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .header-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--light-gray);
    }

    .filters select {
      padding: 8px 12px;
      border: 1px solid var(--light-gray);
      border-radius: 4px;
      margin-right: 10px;
      font-size: 14px;
    }

    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #303f9f;
    }

    button:disabled {
      background-color: #9e9e9e;
      cursor: not-allowed;
    }

    button.danger {
      background-color: var(--danger-color);
      margin-top: auto;
      /* Pushes button to the bottom */
      align-self: flex-end;
      /* Aligns button to the right */
      width: 150px;
    }

    button.save {
      background-color: var(--success-color);
    }

    button.danger:hover {
      background-color: #d32f2f;
    }

    button.save:hover {
      background-color: #45a049;
    }

    .tab-container {
      margin: 20px 0;
      border-bottom: 2px solid var(--light-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #currency-display {
      font-size: 16px;
      padding: 10px;
      align-items: center;
      /* Vertically align items in the middle */
      justify-content: center;
      /* Horizontally align items in the middle (optional) */
    }

    .bold-currency {
      font-weight: bold;
    }

    #add-employee-btn {
      display: none;
      /* Hidden by default */
    }

    .tab-container.staff-active #add-employee-btn {
      display: block;
    }

    .tabs {
      display: flex;
      gap: 2px;
    }

    .tab {
      padding: 12px 24px;
      font-size: 16px;
      font-weight: bold;
      background-color: #999;
      border: none;
      border-radius: 4px 4px 0 0;
      cursor: pointer;
      min-width: 200px;
    }

    .tab.active {
      background-color: var(--primary-color);
      color: white;
    }

    .tab-content {
      display: none;
      padding: 20px 0;
    }

    .tab-content.active {
      display: block;
    }

    .employee-box {
      border-radius: 8px;
      margin-bottom: 10px;
      padding: 10px;
      background-color: f5f5f5;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: border-color 0.3s;
    }

    .employee-box:nth-child(odd) {
      border: 1px solid var(--light-gray);
    }

    .employee-box:nth-child(even) {
      border: 1px solid #bdbdbd;
    }

    .employee-box.error {
      border-color: var(--danger-color);
      background-color: var(--danger-bg);
    }

    .employee-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .employee-info {
      display: grid;
      grid-template-columns: 1fr 1fr 150px 150px 150px 100px 150px;
      gap: 15px;
      margin-bottom: 15px;
    }

    .employee-info .field-group {
      display: flex;
      flex-direction: column;
    }
    

    .field-group label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }

    .field-group input {
      padding: 8px;
      border: 1px solid var(--light-gray);
      border-radius: 4px;
      font-size: 14px;
    }

    .field-group input:disabled {
      background-color: var(--secondary-color);
      cursor: not-allowed;
    }

    .column-headers {
      display: grid;
      grid-template-columns: 30px 80px 200px 80px repeat(13, minmax(65px, 1fr));
      gap: 5px;
      margin-bottom: 10px;
      font-weight: 500;
      font-size: 13px;
      color: #555;
      padding: 1 1px;
      width: 100%;
      /* Fixed width to prevent wrapping */
      justify-items: center;
      text-align: center;
    }

    .column-headers button.add-line {
      width: 24px;
      height: 24px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      background-color: var(--primary-color);
      color: white;
    }

    .column-headers button.add-line:hover {
      background-color: #303f9f;
    }

    .allocation-line {
      display: grid;
      grid-template-columns: 30px 80px 200px 80px repeat(13, minmax(65px, 1fr));
      gap: 5px;
      margin-bottom: 1px;
      justify-items: center;
      text-align: center;
      padding: 1px 1px;
      border-radius: 4px;
      background-color: var(--secondary-color);
      width: 100%;
      /* Fixed width to prevent wrapping */
    }


    .allocation-line button.delete-line {
      width: 24px;
      height: 24px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      background-color: transparent;
      color: #999;
    }

    .allocation-line button.delete-line:hover {
      color: var(--danger-color);
    }

    .allocation-line select,
    .allocation-line input {
      padding: 6px;
      border: 1px solid var(--light-gray);
      border-radius: 4px;
      font-size: 13px;
      width: 100%;
    }


    .grand-total-value div {
      font-size: 12px;
      font-weight: bold;
      text-decoration: underline;
      color: var(--text-color);
      background-color: var(--secondary-color);
      text-align: right;
      padding: 5px;
    }

    .grand-total-value div:last-child {
      font-weight: bold;
      padding-right: 10px;
    }


    .allocation-line input.monthly-input {
      text-align: right;
    }

    .total-value {
      font-size: 12px;
      font-weight: bold;
      color: var(--text-color);
      text-align: right;
      padding: 5px;
      border-radius: 4px;
      background-color: var(--secondary-color);
    }


    .allocation-actions {
      margin-top: 15px;
      display: flex;
      justify-content: flex-end;
    }

    .error-message {
      color: var(--danger-color);
      font-size: 13px;
      margin-top: 10px;
    }

    .newemployee-bottom {
      text-align: right;
    }

    .grand-total {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid var(--light-gray);
    }

    .grand-total-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .grand-total-row span:first-child {
      font-weight: 500;
    }

    .grand-total-row span:last-child {
      font-size: 18px;
      color: var(--primary-color);
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 200px;
    }

    .error-text {
      color: var(--danger-color);
    }

    .save-section {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid var(--light-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .save-info {
      color: #666;
      font-size: 14px;
    }

    .validation-summary {
      color: var(--danger-color);
      font-size: 14px;
      margin-right: 20px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Department Budget Allocation</h1>

    <div class="header-controls">
      <div class="filters">
        <label for="department-filter">Home Department:</label>
        <select id="department-filter">
        </select>

        <label for="iteration-filter">Budget Iteration:</label>
        <select id="iteration-filter">
          <option value="FY25" selected>FY25 (Board Approved)</option>
          <option value="FY25-Q1">FY25-Q1 (Q1 Update)</option>
          <option value="FY25-Q2">FY25-Q2 (Q2 Update)</option>
        </select>
      </div>


    </div>

    <div class="tab-container">
      <div class="tabs">
        <button class="tab active" data-tab="staff">Staff Expenses</button>
        <button class="tab" data-tab="flexible">Flexible Expenses</button>
        <div id="currency-display"></div>
      </div>
      <button id="add-employee-btn" type="button">+ Add New Employee</button>
    </div>
    <div id="staff-container" class="tab-content active">

      <!-- Existing employee containers move here -->
      <div id="employee-containers">
        <!-- Employees will be loaded here dynamically -->
        <div class="loading">Loading employee data...</div>
      </div>
      <div class="newemployee-bottom">
        <button id="add-employee-btn2" type="button">+ Add New Employee</button>
      </div>
      <div class="grand-total">

        <div class="grand-total-row">
          <span>Total Salaries:</span>
          <span id="total-salaries">$0.00</span>
        </div>
        <div class="grand-total-row">
          <span>Total Allocated to Home Department:</span>
          <span id="total-allocated">$0.00</span>
        </div>
        <div class="grand-total-row">
          <span>Total Allocated to Home Department / Core Fund:</span>
          <span id="total-allocated-core">$0.00</span>
        </div>
      </div>





    </div>
    <div id="flexible-container" class="tab-content">
      <!-- New flexible expenses content will go here -->
      <div id="flexible-expenses"></div>
    </div>
    <div class="save-section">
      <div>
        <div class="save-info">All changes will be saved to the current iteration: <span
            id="current-iteration-display">FY25</span></div>
        <div id="validation-summary" class="validation-summary"></div>
      </div>
      <button id="save-btn" type="button" class="save">Save Budget Data</button>
    </div>
  </div>
</body>


<script>
  // Replace the script section in index2.html with this updated version
  document.addEventListener('DOMContentLoaded', function () {
    // Global variables
    let budgetData = null;
    let employeeData = [];
    let departments = [];
    let fx_rates = [];
    let currentDepartment = '';
    let currentIteration = 'FY25';
    let currentCurrency = '';
    let hasValidationErrors = false;
    let availableIterations = [];

    // Initialize the application
    init();

    async function init() {
      try {
        // Fetch data from API endpoint/JSON file
        await fetchBudgetData();
        setupEventListeners();
        loadIterationData(currentIteration);
        updateIterationUI();
        renderEmployees();
        renderExpenses();
        updateTotals();
        validateAllEmployees();
        document.querySelector('.tab-container').classList.add('staff-active');
      } catch (error) {
        console.error('Failed to initialize application:', error);
        document.getElementById('employee-containers').innerHTML =
          `<div class="error-text">Failed to load employee data. Please try again.</div>`;
      }
    }

    async function fetchBudgetData() {
      try {
        // In a real application, this would be a fetch call to an API endpoint
        // For this example, we'll simulate fetching the data
        const response = await fetch('budget-data.json');
        if (!response.ok) {
          throw new Error('Failed to fetch budget data');
        }
        budgetData = await response.json();

        // Extract available iterations from metadata
        availableIterations = budgetData.metadata.availableIterations;

        // Extract available fx rates from metadata
        fx_rates = budgetData.metadata.fx_rates;        // Extract departments from budgetData

        departments = budgetData.departments.sort((a, b) => a.value.localeCompare(b.value));

        // Set the currentDepartment to the first department value
        if (departments.length > 0) {
          currentDepartment = departments[0].value;
          const selectedDepartment = departments.find(dept => dept.value === currentDepartment);
          currentCurrency = selectedDepartment ? selectedDepartment.currency : '';
        }

        // Populate iteration dropdown
        const iterationDropdown = document.getElementById('iteration-filter');
        iterationDropdown.innerHTML = '';
        availableIterations.forEach(iteration => {
          const option = document.createElement('option');
          option.value = iteration.id;
          option.textContent = iteration.name;
          if (iteration.id === currentIteration) {
            option.selected = true;
          }
          iterationDropdown.appendChild(option);
        });

        // Populate department dropdown
        const departmentDropdown = document.getElementById('department-filter');
        departmentDropdown.innerHTML = '';
        departments.forEach(dept => {
          const option = document.createElement('option');
          option.value = dept.value;
          option.textContent = dept.label;
          if (dept.value === currentDepartment) {
            option.selected = true;
          }
          departmentDropdown.appendChild(option);
        });

        displayCurrency();

      } catch (error) {
        console.error('Failed to fetch budget data:', error);
        throw error;
      }
    }

    function loadIterationData(iterationId) {
      const iteration = budgetData.iterations.find(iter => iter.iterationId === iterationId);
      if (!iteration) {
        console.error(`Iteration with ID ${iterationId} not found`);
        return;
      }

      employeeData = iteration.employees.map(employee => {
        // Initialize fields that we aren't getting from the DB/JSON
        employee.salaryOld = employee.salary;
        employee.salaryChangeMonth = 0;
        employee.currency = employee.currency || currentCurrency;
        employee.isExisting = true;

        // If the employee has no allocations, create a default one
    if (!employee.allocations || employee.allocations.length === 0) {
      employee.allocations = [{
        id: Date.now() + 1, // Another temporary ID
        department: currentDepartment,
        percent: 100,
        percentCore: 100,
        monthlyValues: generateMonthlyValues(employee.salary,employee.salaryOld,employee.salaryChangeMonth,100,employee.currency)
      }];
    }

        return employee;
      }); currentIteration = iterationId;
    }

    function updateIterationUI() {
      document.getElementById('current-iteration-display').textContent =
        availableIterations.find(iter => iter.id === currentIteration)?.name || currentIteration;
    }

    function setupEventListeners() {
      // Department filter change event
      document.getElementById('department-filter').addEventListener('change', function (e) {
        currentDepartment = e.target.value;
        const selectedDepartment = departments.find(dept => dept.value === currentDepartment);
        currentCurrency = selectedDepartment ? selectedDepartment.currency : '';
        renderEmployees();
        updateTotals();
        validateAllEmployees();
        displayCurrency();
      });

      // Iteration filter change event
      document.getElementById('iteration-filter').addEventListener('change', function (e) {
        currentIteration = e.target.value;
        loadIterationData(currentIteration);
        updateIterationUI();
        renderEmployees();
        updateTotals();
        validateAllEmployees();
      });

      // Add event listener for both add-employee-btn (top of page) and add-employee-btn2 (bottom of page)
      document.querySelectorAll('#add-employee-btn, #add-employee-btn2').forEach(button => {
        button.addEventListener('click', () => {
          addNewEmployee();
          window.scrollTo({
            top: document.body.scrollHeight, // Scroll to the bottom
            behavior: "smooth"               // Smooth scroll
          });
        });
      });


      // Save button
      document.getElementById('save-btn').addEventListener('click', saveData);

      // Add tab switching functionality
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          // Remove active class from all tabs and content
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

          // Add active class to clicked tab and corresponding content
          tab.classList.add('active');
          const tabContent = document.getElementById(`${tab.dataset.tab}-container`);
          tabContent.classList.add('active');

          // Update tab container class based on active tab
          const tabContainer = document.querySelector('.tab-container');
          if (tab.dataset.tab === 'staff') {
            tabContainer.classList.add('staff-active');
          } else {
            tabContainer.classList.remove('staff-active');
          }
        });
      });
    }

    function renderEmployees() {
      const container = document.getElementById('employee-containers');
      container.innerHTML = '';
      // Filter employees by home department
      const filteredEmployees = employeeData.filter(employee =>
        employee.homeDepartment === currentDepartment
      );

      if (filteredEmployees.length === 0) {
        container.innerHTML = '<div class="loading">No employees found for the selected department.</div>';
        return;
      }

      filteredEmployees.forEach(employee => {
        container.appendChild(createEmployeeBox(employee));
      });
    }

    function renderExpenses() {
      const container = document.getElementById('flexible-expenses');
      container.innerHTML = 'Stuff goes here!';

    }


    function createEmployeeBox(employee) {
      const box = document.createElement('div');
      box.className = 'employee-box';
      box.dataset.employeeId = employee.id;

      // Employee header section
      //const header = document.createElement('div');
      //header.className = 'employee-header';

      //const title = document.createElement('h3');
      //title.textContent = employee.name;
      //header.appendChild(title);



      //box.appendChild(header);

      // Employee info section
      const info = document.createElement('div');
      info.className = 'employee-info';

      // Name field
      const nameGroup = document.createElement('div');
      nameGroup.className = 'field-group';
      const nameLabel = document.createElement('label');
      nameLabel.textContent = 'Employee Name';
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = employee.name;
      nameInput.disabled = employee.isExisting;
      nameInput.addEventListener('change', e => updateEmployeeField(employee.id, 'name', e.target.value));
      nameGroup.appendChild(nameLabel);
      nameGroup.appendChild(nameInput);
      info.appendChild(nameGroup);

      // Job Title field
      const titleGroup = document.createElement('div');
      titleGroup.className = 'field-group';
      const titleLabel = document.createElement('label');
      titleLabel.textContent = 'Job Title';
      const titleInput = document.createElement('input');
      titleInput.type = 'text';
      titleInput.value = employee.jobTitle;
      titleInput.addEventListener('change', e => updateEmployeeField(employee.id, 'jobTitle', e.target.value));
      titleGroup.appendChild(titleLabel);
      titleGroup.appendChild(titleInput);
      info.appendChild(titleGroup);

      // SalaryOld field
const oldsalaryGroup = document.createElement('div');
oldsalaryGroup.className = 'field-group';
const oldsalaryLabel = document.createElement('label');
oldsalaryLabel.textContent = 'Current Annual Salary';
const oldsalaryDisplay = document.createElement('div'); // Changed to div
oldsalaryDisplay.textContent = formatCurrency(employee.salaryOld, employee.currency); // Set text content
oldsalaryGroup.appendChild(oldsalaryLabel);
oldsalaryGroup.appendChild(oldsalaryDisplay); // Append the div
info.appendChild(oldsalaryGroup);

      // Salary field
      const salaryGroup = document.createElement('div');
      salaryGroup.className = 'field-group';
      const salaryLabel = document.createElement('label');
      salaryLabel.textContent = 'New Annual Salary';
      const salaryInput = document.createElement('input');
      salaryInput.type = 'text';
      salaryInput.value = formatCurrency(employee.salary, employee.currency);
      salaryInput.addEventListener('change', e => {
        // Get the raw input value, remove non-numeric characters (except dots)
        let rawValue = e.target.value.replace(/[^0-9.]/g, '');

        // Validate if the value is a whole number
        if (!/^\d+$/.test(rawValue)) {  // Check if the value is a whole number
          alert("Please enter a valid whole number.");
          e.target.value = previousValue; // Reset to the previous valid value
        } else {
          // If valid, format and update the input
          e.target.value = formatCurrency(parseInt(rawValue), employee.currency);

          // Remove commas and $ sign before passing to updateSalary
          let cleanValue = e.target.value.replace(/[^0-9.]/g, ''); // Remove any commas and $ sign
          updateSalary(employee.id, parseFloat(cleanValue), employee.salaryOld, employee.salaryChangeMonth, employee.currency);

          // Update the previous value to the current valid value
          previousValue = e.target.value; // Save the newly formatted value
        }
      });

      salaryGroup.appendChild(salaryLabel);
      salaryGroup.appendChild(salaryInput);
      info.appendChild(salaryGroup);


            // Month of Salary Change
            const salarychangeGroup = document.createElement('div');
salarychangeGroup.className = 'field-group';
const salarychangeLabel = document.createElement('label');
salarychangeLabel.textContent = 'Month of Salary Change';
const salarychangeInput = document.createElement('select');
salarychangeInput.className = 'salary-change-month';
salarychangeInput.addEventListener('change', e => {

  updateSalary(employee.id, employee.salary, employee.salaryOld, e.target.value, employee.currency);
  
    });

const months = [
  { value: 0, label: 'July' },
  { value: 1, label: 'August' },
  { value: 2, label: 'September' },
  { value: 3, label: 'October' },
  { value: 4, label: 'November' },
  { value: 5, label: 'December' },
  { value: 6, label: 'January' },
  { value: 7, label: 'February' },
  { value: 8, label: 'March' },
  { value: 9, label: 'April' },
  { value: 10, label: 'May' },
  { value: 11, label: 'June' }
];

months.forEach(month => {
  const option = document.createElement('option');
  option.value = month.value;
  option.textContent = month.label;
  salarychangeInput.appendChild(option);
});

salarychangeInput.value = employee.salaryChangeMonth;

salarychangeGroup.appendChild(salarychangeLabel);
salarychangeGroup.appendChild(salarychangeInput);
info.appendChild(salarychangeGroup);


// Salary Currency Override
const salaryCurrencyGroup = document.createElement('div');
salaryCurrencyGroup.className = 'field-group';
const salaryCurrencyLabel = document.createElement('label');
salaryCurrencyLabel.textContent = 'Salary Currency';
const salaryCurrencyInput = document.createElement('select');
salaryCurrencyInput.className = 'salary-change-currency';
salaryCurrencyInput.addEventListener('change', e => {

  updateSalary(employee.id, employee.salary, employee.salaryOld, employee.salaryChangeMonth, e.target.value);
  
    });

const currencies = [
  { value: 'USD', label: 'USD' },
  { value: 'EUR', label: 'EUR' },
  { value: 'GBP', label: 'GBP' }
];

currencies.forEach(currency => {
  const option = document.createElement('option');
  option.value = currency.value;
  option.textContent = currency.label;
  salaryCurrencyInput.appendChild(option);
});

salaryCurrencyInput.value = employee.currency;

salaryCurrencyGroup.appendChild(salaryCurrencyLabel);
salaryCurrencyGroup.appendChild(salaryCurrencyInput);
info.appendChild(salaryCurrencyGroup);

      // Delete button for new employees only
      if (!employee.isExisting) {
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'danger';
        deleteBtn.textContent = 'Delete Employee';
        deleteBtn.addEventListener('click', () => deleteEmployee(employee.id));
        info.appendChild(deleteBtn);
      }

      box.appendChild(info);

      // Column headers
      const headers = document.createElement('div');
      headers.className = 'column-headers';

      // Create the button
      const addLineBtn = document.createElement('button');
      addLineBtn.textContent = '+';
      addLineBtn.classList.add('add-line');
      // Add event listener before appending
      addLineBtn.addEventListener('click', () => addAllocationLine(employee.id));

      // Append button first
      headers.appendChild(addLineBtn);

      // Create the headers separately and append them one by one
      const columnTitles = [
        'Allocation %', 'Department', '% Core', 'Jul', 'Aug', 'Sep', 'Oct',
        'Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Total' // Added 'Total'
      ];

      columnTitles.forEach(title => {
        const div = document.createElement('div');
        div.textContent = title;
        headers.appendChild(div);
      });

      box.appendChild(headers);

      // Allocation lines
      employee.allocations.forEach(allocation => {
        box.appendChild(createAllocationLine(employee.id, allocation));
      });

      box.appendChild(createGrandTotalRow(employee));

      // Add allocation button
      //const actions = document.createElement('div');
      //actions.className = 'allocation-actions';
      //const addLineBtn = document.createElement('button');
      //addLineBtn.textContent = '+ Add Allocation Line';
      //addLineBtn.addEventListener('click', () => addAllocationLine(employee.id));
      //actions.appendChild(addLineBtn);
      //box.appendChild(actions);

      // Error message container (initially empty)
      const errorMsg = document.createElement('div');
      errorMsg.className = 'error-message';
      errorMsg.id = `error-${employee.id}`;
      box.appendChild(errorMsg);

      return box;
    }

    function createAllocationLine(employeeId, allocation) {
      const line = document.createElement('div'); 0
      line.className = 'allocation-line';
      line.dataset.allocationId = allocation.id;

      // Delete button
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-line';
      deleteBtn.innerHTML = '&times;';
      deleteBtn.addEventListener('click', () => deleteAllocationLine(employeeId, allocation.id));
      line.appendChild(deleteBtn);

      // Allocation percentage
      const percentInput = document.createElement('input');
      percentInput.type = 'text';
      percentInput.min = 0;
      percentInput.max = 100;
      percentInput.value = allocation.percent + '%';
      percentInput.addEventListener('change', e => {
        let value = parseFloat(e.target.value.replace(/[^0-9.]/g, ''));

        // Validate if the value is between 0 and 100
        if (value >= 0 && value <= 100) {
          // If valid, update the value and proceed with the logic
          previousValue = e.target.value; // Update the previous value with the valid one
          updateAllocationPercent(employeeId, allocation.id, parseFloat(e.target.value))
        } else {
          alert('Please enter a value between 0 and 100.');
          // Reset to the previous valid value
          e.target.value = previousValue + '%';
        }
      });
      line.appendChild(percentInput);

      // Department dropdown
      const deptSelect = document.createElement('select');
      departments.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept.value;
        option.textContent = dept.label;
        if (dept.value === allocation.department) {
          option.selected = true;
        }
        deptSelect.appendChild(option);
      });
      deptSelect.addEventListener('change', e =>
        updateAllocationField(employeeId, allocation.id, 'department', e.target.value)
      );
      line.appendChild(deptSelect);

      // Core Allocation percentage
      const percentCoreInput = document.createElement('input');
      percentCoreInput.type = 'text';
      percentCoreInput.min = 0;
      percentCoreInput.max = 100;
      percentCoreInput.value = allocation.percentCore + '%';

      percentCoreInput.addEventListener('change', e => {
        let value = parseFloat(e.target.value.replace(/[^0-9.]/g, ''));

        // Validate if the value is between 0 and 100
        if (value >= 0 && value <= 100) {
          updateAllocationField(employeeId, allocation.id, 'percentCore', value);

          // Format the input
          e.target.value = value + '%';

          // Update totals to reflect the new percentCore value
          updateTotals();

          // Optional: validate the employee
          //validateEmployee(employeeId);

        } else {
          alert('Please enter a value between 0 and 100.');
          // Reset to the previous valid value
          e.target.value = allocation.percentCore + '%';
        }
      });
      line.appendChild(percentCoreInput);

      // Monthly values
      allocation.monthlyValues.forEach((value, index) => {
        const monthInput = document.createElement('input');
        monthInput.type = 'text';
        monthInput.className = 'monthly-input';
        monthInput.value = formatCurrency(value, currentCurrency);
        monthInput.readOnly = false;
        // Event listener to handle change and format the input value
        monthInput.addEventListener('blur', (e) => { // 'blur' triggers when the user leaves the input box
          let rawValue = e.target.value.replace(/[^0-9.]/g, ''); // Remove non-numeric characters (except dot)

          // Validate if the value is a whole number
          if (!/^\d+$/.test(rawValue)) {  // Check if the value is a whole number
            alert("Please enter a valid whole number.");
            e.target.value = formatCurrency(parseInt(value), currentCurrency); // Reset to the previous valid value
          } else {
            // Parse and format the input value
            let newValue = parseInt(rawValue);
            e.target.value = formatCurrency(newValue, currentCurrency);

            // Find the employee and allocation to update
            const employee = findEmployee(employeeId);
            if (employee) {
              const allocIndex = employee.allocations.findIndex(a => a.id === allocation.id);
              if (allocIndex !== -1) {
                // Update the monthly value in the actual employee data structure
                employee.allocations[allocIndex].monthlyValues[index] = newValue;

                // Run validation for this employee
                validateEmployee(employee);

                // Update totals to reflect the new monthly value
                updateTotals();
              }
            }
          }
        });
        line.appendChild(monthInput);
      });

      // Calculate and display the total of monthly values
      const totalValue = allocation.monthlyValues.reduce((sum, val) => sum + val, 0);
      const totalCell = document.createElement('div');
      totalCell.className = 'monthly-input total-value';
      totalCell.textContent = formatCurrency(totalValue, currentCurrency);
      totalCell.id = `linetotal-${allocation.id}`; // Unique ID using allocation.id
      line.appendChild(totalCell);

      return line;
    }

    function addNewEmployee() {
      const newEmployee = {
        id: Date.now(), // Use timestamp as temporary ID
        name: 'New Employee',
        jobTitle: 'Job Title',
        salary: 0,
        salaryOld: 0,
        salaryChangeMonth: 0,
        currency: currentCurrency,
        homeDepartment: currentDepartment,
        isExisting: false,
        allocations: [
          {
            id: Date.now() + 1, // Another temporary ID
            department: currentDepartment,
            percent: 100,
            percentCore: 100,
            monthlyValues: Array(12).fill(0)
          }
        ]
      };

      employeeData.push(newEmployee);
      renderEmployees();
      updateTotals();
      validateAllEmployees();
    }

    function deleteEmployee(employeeId) {
      if (confirm('Are you sure you want to delete this employee?')) {
        employeeData = employeeData.filter(employee => employee.id !== employeeId);
        renderEmployees();
        updateTotals();
        validateAllEmployees();
      }
    }

    function addAllocationLine(employeeId) {
      const employee = findEmployee(employeeId);
      if (!employee) return;

      const newAllocation = {
        id: Date.now(), // Use timestamp as temporary ID
        department: currentDepartment,
        percent: 0,
        percentCore: 100,
        monthlyValues: generateMonthlyValues(employee.salary,employee.salaryOld,employee.salaryChangeMonth,0,employee.currency) 
      };

      employee.allocations.push(newAllocation);
      renderEmployees();
      validateAllEmployees();
    }

    function deleteAllocationLine(employeeId, allocationId) {
      const employee = findEmployee(employeeId);
      if (!employee) return;

      if (employee.allocations.length <= 1) {
        alert('Cannot delete the last allocation line. Every employee must have at least one allocation.');
        return;
      }

      employee.allocations = employee.allocations.filter(allocation => allocation.id !== allocationId);
      renderEmployees();
      validateAllEmployees();
      updateTotals();
    }

    function updateEmployeeField(employeeId, field, value) {
      const employee = findEmployee(employeeId);
      if (!employee) return;

      employee[field] = value;
    }

    function updateSalary(employeeId, newSalary, salaryOld, salaryChangeMonth, currency) {
      const employee = findEmployee(employeeId);
      
      if (!employee) return;

      employee.currency = currency;
      employee.salary = newSalary;
      employee.salaryChangeMonth = salaryChangeMonth;
      //alert(salaryChangeMonth);

      // Update all allocation monthly values
      employee.allocations.forEach(allocation => {
        allocation.monthlyValues = generateMonthlyValues(newSalary, salaryOld, salaryChangeMonth,allocation.percent,currency);
      });

      renderEmployees();
      updateTotals();
      validateAllEmployees();
    }

    function updateAllocationField(employeeId, allocationId, field, value) {
      const employee = findEmployee(employeeId);
      if (!employee) return;

      const allocation = employee.allocations.find(a => a.id === allocationId);
      if (!allocation) return;

      allocation[field] = value;

      // If changing department, may need to update totals
      updateTotals();
      validateAllEmployees();
    }

    function updateAllocationPercent(employeeId, allocationId, newPercent) {
      const employee = findEmployee(employeeId);
      if (!employee) return;

      const allocation = employee.allocations.find(a => a.id === allocationId);
      if (!allocation) return;

      allocation.percent = newPercent;
      allocation.monthlyValues = generateMonthlyValues(employee.salary,employee.salaryOld,employee.salaryChangeMonth,newPercent,employee.currency) 

      renderEmployees();
      validateAllEmployees();
      updateTotals();
    }

    function validateEmployee(employee) {
      // Check if total allocation is not 100%
      const totalPercent = employee.allocations.reduce((sum, allocation) =>
        sum + allocation.percent, 0);

      //const totalAllocatedValue = employee.allocations.reduce((sum, allocation) => {
        // Check if allocation.monthlyValues is an array and is defined
       // if (Array.isArray(allocation.monthlyValues)) {
       //   const allocationTotal = allocation.monthlyValues.reduce((subSum, value) => subSum + value, 0);
       //   return sum + allocationTotal; // Add the allocation total to the main sum
       // } else {
       //   // If monthlyValues is not an array or is undefined, skip this allocation
       //   return sum;
       // }
      //}, 0);
      const errorElement = document.getElementById(`error-${employee.id}`);
      const employeeBox = document.querySelector(`.employee-box[data-employee-id="${employee.id}"]`);

      errorElement.textContent = '';

      if (totalPercent != 100) {
        errorElement.textContent += 'Allocations must total to 100%.';
        employeeBox.classList.add('error');
        return false;
        console.log()
      }
      //Allow for small rounding differences (e.g., $11 difference in a $100,000 salary)
      //const roundingTolerance = Math.max(12, Math.round(employee.salary * 0.0001)); // 0.01% tolerance or at least $12

      //if (totalAllocatedValue - employee.salary > roundingTolerance) {
      //  errorElement.textContent += '  The total of all Monthly values must not be greater than the salary amount.'; employeeBox.classList.add('error');
      //}


      else {
        errorElement.textContent = '';
        employeeBox.classList.remove('error');
        return true;
      }
    }

    function validateAllEmployees() {
      const filteredEmployees = employeeData.filter(employee =>
        employee.homeDepartment === currentDepartment
      );

      let validationErrors = 0;

      filteredEmployees.forEach(employee => {
        if (!validateEmployee(employee)) {
          validationErrors++;
        }
      });

      // Update save button state
      hasValidationErrors = validationErrors > 0;
      const saveBtn = document.getElementById('save-btn');
      saveBtn.disabled = hasValidationErrors;

      // Update validation summary
      const validationSummary = document.getElementById('validation-summary');
      if (hasValidationErrors) {
        validationSummary.textContent = `Please fix ${validationErrors} staff validation error${validationErrors > 1 ? 's' : ''} before saving.`;
      } else {
        validationSummary.textContent = '';
      }

      return !hasValidationErrors;
    }

    function updateTotals() {
      const filteredEmployees = employeeData.filter(employee =>
        employee.homeDepartment === currentDepartment
      );

   

  // Calculate total allocated to home department
  let totalAllocated = 0;
  let totalSalary = 0;
  filteredEmployees.forEach(employee => {
    let employeeTotal = 0;
    employee.allocations.forEach(allocation => {
      totalSalary += allocation.monthlyValues.reduce((sum, val) => sum + val, 0);
      if (allocation.department === currentDepartment) {
        // Sum the monthly values for each allocation
        const allocationTotal = allocation.monthlyValues.reduce((sum, val) => sum + val, 0);
        totalAllocated += allocationTotal;
      }
          // Update the total for each allocation line
          const totalValue = allocation.monthlyValues.reduce((sum, val) => sum + val, 0);
          const totalCell = document.getElementById(`linetotal-${allocation.id}`);
          if (totalCell) {
            totalCell.textContent = formatCurrency(totalValue, currentCurrency);
          }

          // Add to employee's total
          employeeTotal += totalValue;
        });

        // Update the grand total for the employee
        const grandTotalCell = document.getElementById(`grandtotal-${employee.id}`);
        if (grandTotalCell) {
          grandTotalCell.textContent = `${formatCurrency(employeeTotal, currentCurrency)}`;
        }
      });

  // Calculate total allocated to core
  let totalCore = 0;
  filteredEmployees.forEach(employee => {
    employee.allocations.forEach(allocation => {
      if (allocation.department === currentDepartment) {
        // Sum the monthly values for each allocation and multiply by percentCore
        const allocationTotal = allocation.monthlyValues.reduce((sum, val) => sum + val, 0);
        totalCore += (allocationTotal * (allocation.percentCore / 100));
      }
    });
  });

      document.getElementById('total-salaries').textContent = formatCurrency(totalSalary, currentCurrency);
      document.getElementById('total-allocated').textContent = formatCurrency(totalAllocated, currentCurrency);
      document.getElementById('total-allocated-core').textContent = formatCurrency(totalCore, currentCurrency);
    }

    function createGrandTotalRow(employee) {
      const grandTotalRow = document.createElement('div');
      grandTotalRow.className = 'allocation-line grand-total-value';

      // Empty cells to align with the structure of allocation lines
      for (let i = 0; i < 16; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.textContent = ''; // Keeps the structure aligned
        grandTotalRow.appendChild(emptyCell);
      }

      // Calculate the grand total of all allocations
      const grandTotalValue = employee.allocations.reduce((sum, allocation) => {
        return sum + allocation.monthlyValues.reduce((subSum, val) => subSum + val, 0);
      }, 0);

      // Grand total cell
      const grandTotalCell = document.createElement('div');
      grandTotalCell.textContent = formatCurrency(grandTotalValue, currentCurrency);
      grandTotalCell.id = `grandtotal-${employee.id}`;
      grandTotalRow.appendChild(grandTotalCell);

      return grandTotalRow;
    }

    function saveData() {
      if (hasValidationErrors) {
        alert('Please fix all validation errors before saving.');
        return;
      }

      // Find current iteration and update its employee data
      const iterationIndex = budgetData.iterations.findIndex(iter => iter.iterationId === currentIteration);
      if (iterationIndex === -1) {
        alert('Cannot find the current iteration to save.');
        return;
      }
      // Update the employee data in the budget data structure
      budgetData.iterations[iterationIndex].employees = employeeData;

      // In a real application, this would post data to an API endpoint
      const dataToSave = {
        iterationId: currentIteration,
        timestamp: new Date().toISOString(),
        employees: employeeData
      };

      // Simulate API call
      console.log('Saving data:', dataToSave);
      alert(`Data for iteration ${currentIteration} saved successfully.`);
    }

    // Helper functions
    function findEmployee(id) {
      return employeeData.find(employee => employee.id === id);
    }

    function generateMonthlyValues(newSalary, salaryOld, salaryChangeMonth,percent,currency) {
      
      if(currentCurrency != currency)  //if employee currency is not the working corrency, convert salary to working currency
      {
        const fx_rate = fx_rates.find(rate => rate.from === currency && rate.to === currentCurrency);
        newSalary = newSalary * fx_rate.rate;
        salaryOld = salaryOld * fx_rate.rate;
      }
      
      const totalAmountold = salaryOld * (percent / 100);
      const totalAmountNew = newSalary * (percent / 100);
      const baseMonthlyAmountOld = totalAmountold / 12;
      const baseMonthlyAmountNew = totalAmountNew / 12;
      const roundedValues = Array(11);
      sumNewValues = 0;
      
      //console.log(salaryOld);
      //console.log (baseMonthlyAmountOld);
      //console.log(12-(12-salaryChangeMonth));
      //console.log(newSalary);
      //console.log (baseMonthlyAmountNew);
      //console.log((12-salaryChangeMonth));      
      // Generate 11 months of rounded values
      for(let i = 0; i < 11; i++) {
        if (i < salaryChangeMonth) {
          roundedValues.push(Math.round(baseMonthlyAmountOld));
        } else {
         // console.log ('pushnew:'+Math.round(baseMonthlyAmountNew))
          roundedValues.push(Math.round(baseMonthlyAmountNew));
          sumNewValues += Math.round(baseMonthlyAmountNew);
        }
      }

      // The last month adjusts to make the total exactly match the expected amount
      roundedValues.push((Math.round(baseMonthlyAmountNew * (12-salaryChangeMonth)) - sumNewValues));
      return roundedValues;
    }

    function formatCurrency(amount, currency) {
      const numberFormat = new Intl.NumberFormat();
      switch (currency || 'USD') {
        case 'USD':
          return '$' + numberFormat.format(amount);
        case 'GBP':
          return '£' + numberFormat.format(amount); // Use the correct GBP symbol
        case 'EUR':
          return '€' + numberFormat.format(amount); // Use the correct EUR symbol      
        default:
          return numberFormat.format(amount); // Just format the number if no currency is set
      }
    }

    function displayCurrency() {
      //const department = departments.find(dept => dept.value === currentDepartment);
      const currencyDisplay = document.getElementById('currency-display');
      currencyDisplay.innerHTML = 'This department is budgeting in: <span class="bold-currency">' + currentCurrency + '</span>';
    }


  });
</script>
</body>

</html>